<html>

<head>
  <link rel="stylesheet" type="text/css" href="../css/app.css">
  <link rel="stylesheet" type="text/css" href="../css/animate.css">
</head>

<body>
  <div id="intro">
    <div class="players left"></div>
    <div class="players right"></div>

    <div class="logo animated fadeIn">
      <div class="title animated lightSpeedIn">MOVIE DRINKING GAME</div>
      <img class="beer animated rotateIn">
      <div class="ip animated slideInRight"></div>
      <button class="start animated bounceInUp">Start</button>
    </div>
  </div>

  <video id="movie" class="movie" controls>
    <source id='avi'
    src="file:///C:/Users/Ryan%20Mueller/Downloads/Hell%20Comes%20to%20Frogtown%20(1988)%20-%20720p/Hell.Comes.to.Frogtown.1988.720p.BluRay.x264.VPPV.mp4"
    type='video/mp4'>
    <p>Your user agent does not support the HTML5 Video element.</p>
  </video>

  <div class="overlay animated" style="display: none;">
    <div id="question">
  		<div class="badge">
  		  <img class="beer">
  		</div>
    	<div id="question-text"></div>
	   </div>

    <table>
      </tr>
      <tr>
        <td id="answer-0" class="answer"></td>
        <td id="answer-1" class="answer"></td>
      </tr>
      <tr>
        <td id="answer-2" class="answer"></td>
        <td id="answer-3" class="answer"></td>
      </tr>
    </table>

    <div class="timer"></div>
  </div>

  <div class="drinks-overlay animated" style="display: none;">
    <div class="drinks-overlay-container circle" style="display: none;">
      <p id="numDrinks"></p>
    </div>
    <div class="drinks-overlay-container sociables animated flash infinite" style="display: none;">
      <p>SOCIABLES!</p>
    </div>
  </div>

  <div class="credits">
    <div class="movie-title">PREDATOR</div>
    <div class="title">Best Duder</div>
    <div class="name most-correct"></div>
    <div class="title">Worst Duder</div>
    <div class="name most-wrong"></div>
    <div class="title">Where was this Duder</div>
    <div class="name most-missed"></div>
    <div class="title">Drunkest Duder</div>
    <div class="name most-drinks"></div>
    <div class="title">Quickest Duder</div>
    <div class="name quickest-answers"></div>
    <div class="title">Longest Streak Duder</div>
    <div class="name best-streak"></div>
  </div>

  <script>
    const {ipcRenderer} = require('electron');
    const $ = require('jquery');
    const os = require('os');
    const interfaces = os.networkInterfaces();

    $('.ip').html(interfaces['Wi-Fi'][1].address + ':3001');

    $('.start').click(function () {
      ipcRenderer.send('start-game');
      $('#intro').fadeOut();
      $('#movie').get(0).play();
    })
  </script>

  <script>
    var movie = document.querySelector('.movie');
    var timer = $('.timer');

    movie.addEventListener('timeupdate', function () {
     ipcRenderer.send('movie-time', movie.currentTime);
    })

    ipcRenderer.on('new-player', function(event, name, state) {
      var div = '<div class="player animated pulse infinite">' + name +'</div>';
      var playersDiv = (Math.random() >= 0.5) ? $('.players.left') : $('.players.right');
      var top = Math.random() * parseInt(playersDiv.css('height'), 10);
      var left = Math.random() * parseInt(playersDiv.css('width'), 10);

      var playerEl = $(div).appendTo(playersDiv).css({
        top: top + 'px',
        left: left + 'px'
      });
    });

    ipcRenderer.on('show-question', function(event, question) {
      $('#question-text').html(question.text);

      showQuestion();
    });

    ipcRenderer.on('show-answers', function(event, answers, duration) {
      $('#answer-0').html('A) ' + answers[0]);
      $('#answer-1').html('B) ' + answers[1]);
      $('#answer-2').html('C) ' + answers[2]);
      $('#answer-3').html('D) ' + answers[3]);
      $('table').css('visibility', 'visible');

      startTimer(duration);
    });

    ipcRenderer.on('show-correct-answers', function(event, answers) {
      for (var i=0; i<answers.length; i++) {
        stopTimer();
        $('#answer-' + answers[i]).addClass('correct');
      }
    });

    ipcRenderer.on('show-drinks', function(event, drinks) {
      $('.drinks-player').remove();
      $('.drinks-overlay').show();

      var numDrinkers = drinks.length;
      var drinksEl = $('.drinks-overlay-container.circle');

      if (numDrinkers == 0) {
        $('.drinks-overlay-container.sociables').show();
        return;
      } else {
        drinksEl.show();
      }

      var offset = drinksEl.offset();
      var width = drinksEl.width();
      var radius = width / 2;
      var fontSize = 20 + 35 / numDrinkers;

      // Two looks WAY too far apart
      if (numDrinkers == 2) {
        numDrinkers = 6;
      }

      console.log(offset);
      console.log(width);
      console.log(radius);

      // All the players have the same drinks
      drinksEl.find('p').html(drinks[0].drinks);

      // Add the names of the players who got drinks
      var slope = 0;
      var i = 0;
      for (player in drinks) {
         var degrees;

         if (i == numDrinkers - 1 && !(i % 2)) {
           degrees = 0;
         } else {
           if (!(i % 2)) {
             slope += 100.0 / numDrinkers;
             degrees = slope;
           } else {
             degrees = -slope;
           }
         }

         var playerEl = $('<div class="drinks-player animated"></div>').appendTo('.drinks-overlay');

         playerEl.offset({
           top: offset.top + radius + (Math.sin(degrees * (Math.PI / 180)) * (radius + 30 + slope * 0.3)),
           left: offset.left + radius + (Math.cos(degrees * (Math.PI/ 180)) * (radius + 30 + slope * 0.3))
         })
         .text(drinks[player].name)
         .addClass(getRandomShowClass())
         .css({
           'font-size' : fontSize + 'px'
         })
         .show();

         // Go to the next position
         i++;
      }
    });

    ipcRenderer.on('hide-question', function(event) {
      hideQuestion();
      $('.drinks-overlay').hide();
      $('.drinks-overlay-container').hide();
      $('table').css('visibility', 'hidden');
      $('.correct').removeClass('correct');
    });

    ipcRenderer.on('end-game', function(event, statsJson) {
      var statistics = JSON.parse(statsJson);

      $('.movie').fadeOut(1000, function() {
        $('.most-correct').html(statistics.mostCorrectAnswers.name);
        $('.most-wrong').html(statistics.mostWrongAnswers.name);
        $('.most-missed').html(statistics.mostMissedAnswers.name);
        $('.best-streak').html(statistics.bestStreak.name);
        $('.most-drinks').html(statistics.mostDrinks.name);
        $('.quickest-answers').html(statistics.bestAnswerSpeed.name);

        $('.credits').addClass('animate');
      });
    });
  </script>

  <script>
    let interval;

    function startTimer(duration) {
      var startTime = movie.currentTime;

      interval = setInterval(function() {
        var currentTime = movie.currentTime;
        var timerWidth = 95.7 - (95.7 * ((currentTime - startTime) / duration));
        timer.css('width', timerWidth + '%');
      }, 50);
    }

    function stopTimer() {
      clearInterval(interval);
    }

    function showQuestion() {
      var images = ['arnold', 'beer', 'cassette', 'champagne', 'confused', 'guitar', 'martini', 'shoes', 'vandamme', 'wine'];
      var index = Math.round(Math.random() * (images.length - 1));
      $('.badge img').attr('class', images[index]);
      $('.overlay').attr('class', 'overlay animated').addClass(this.getRandomShowClass()).show();
    }

    function hideQuestion() {
      $('.overlay').attr('class', 'overlay animated').addClass(getRandomHideClass());
    }

    function getRandomShowClass() {
      var renderFunctions = [
        'bounceIn', 'bounceInDown', 'bounceInLeft', 'bounceInRight', 'bounceInUp',
        'fadeIn', 'fadeInDown', 'fadeInDownBig', 'fadeInLeft', 'fadeInLeftBig', 'fadeInRight', 'fadeInRightBig', 'fadeInUp', 'fadeInUpBig',
        'flipInX', 'flipInY',
        'lightSpeedIn',
        'rotateIn', 'rotateInDownLeft', 'rotateInDownRight', 'rotateInUpLeft', 'rotateInUpRight',
        'rollIn',
        'zoomIn', 'zoomInDown', 'zoomInLeft', 'zoomInRight', 'zoomInUp',
        'slideInDown', 'slideInLeft', 'slideInRight', 'slideInUp'
      ];

      var index = Math.round(Math.random() * (renderFunctions.length - 1));

      return renderFunctions[index];
    }

    function getRandomHideClass() {
      var renderFunctions = [
        'bounceOut', 'bounceOutDown', 'bounceOutLeft', 'bounceOutRight', 'bounceOutUp',
        'fadeOut', 'fadeOutDown',  'fadeOutDownBig', 'fadeOutLeft',  'fadeOutLeftBig',  'fadeOutRight', 'fadeOutRightBig',  'fadeOutUp', 'fadeOutUpBig',
        'flipOutX', 'flipOutY',
        'lightSpeedOut',
        'rotateOut', 'rotateOutDownLeft', 'rotateOutDownRight', 'rotateOutUpLeft', 'rotateOutUpRight',
        'rollOut',
        'zoomOut', 'zoomOutDown', 'zoomOutLeft', 'zoomOutRight', 'zoomOutUp',
        'slideOutDown', 'slideOutLeft', 'slideOutRight', 'slideOutUp'
      ];

      var index = Math.round(Math.random() * (renderFunctions.length - 1));

      return renderFunctions[index];
    }
  </script>

</body>
</html>
